<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="content-type">
  <title>Connect and Cursor Classes</title>
</head>
<body>
<h1>Connect and Cursor Classes</h1>
<hr style="width: 100%; height: 2px;">
There is no distinction between Cursor and Query here. It has been used
interchangebly throughout the generators to mean the same thing. In the
dotNet implementation here Connect handles the connection, transaction
and vendor type management. Cursor (or Query if you prefer) handles the
command and reader as well as isolates the datatype handling based on
vendor. A number in Oracle is not the same as an integer in MsSql.<br>
<hr style="width: 100%; height: 2px;">
<pre>using System;<br>using System.Data;<br><br>namespace Bbd.JPortal<br>{<br>  public class JPortalException : ApplicationException<br>  {<br>    protected JPortalException() : base() {}<br>    public JPortalException(string error) : base(error) {}<br>    public JPortalException(string error, Exception ex) : base(error, ex) {}<br>  }<br>  public enum ParameterType<br>  {<br>    QuestionMark,<br>    Colon,<br>    AtSymbol<br>  }<br>  public enum VendorType<br>  {<br>    Oracle,<br>    SqlServer,<br>    Odbc,<br>    OleDb<br>  }<br>  public class Connect : IDisposable<br>  {<br>    protected IDbConnection connection;<br>    protected IDbTransaction transaction;<br>    protected ParameterType typeOfParameter;<br>    protected VendorType typeOfVendor;<br>    private bool isOpen = false;<br>    public IDbConnection Connection { get { return connection; } }<br>    public IDbTransaction Transaction { get { return transaction; } }<br>    public ParameterType TypeOfParameter { get { return typeOfParameter; } set { typeOfParameter = value; } }<br>    public VendorType TypeOfVendor { get { return typeOfVendor; } set { typeOfVendor = value; } }<br>    public Connect(IDbConnection connection)<br>    {<br>      this.connection = connection;<br>      Type type = connection.GetType();<br>      if (type == typeof(System.Data.Odbc.OdbcConnection))<br>      {<br>        typeOfParameter = ParameterType.QuestionMark;<br>        typeOfVendor = VendorType.Odbc;<br>      }<br>      else if (type == typeof(System.Data.OleDb.OleDbConnection))<br>      {<br>        typeOfParameter = ParameterType.QuestionMark;<br>        typeOfVendor = VendorType.OleDb;<br>      }<br>      else if (type == typeof(System.Data.SqlClient.SqlConnection))<br>      {<br>        typeOfParameter = ParameterType.AtSymbol;<br>        typeOfVendor = VendorType.SqlServer;<br>      }<br>      else<br>      {<br>        typeOfParameter = ParameterType.Colon;<br>        typeOfVendor = VendorType.Oracle;<br>      }<br>    }<br>    public void Open()<br>    {<br>      connection.Open();<br>      isOpen = true;<br>    }<br>    public void Close()<br>    {<br>      if (isOpen)<br>      {<br>        if (transaction != null)<br>        {<br>          Rollback();<br>          transaction.Dispose();<br>          transaction = null;<br>        }<br>        connection.Close();<br>        isOpen = false;<br>      }<br>    }<br>    public void BeginTransaction()<br>    {<br>      transaction = connection.BeginTransaction();<br>    }<br>    public void Commit()<br>    {<br>      if (transaction != null)<br>      {<br>        transaction.Commit();<br>        transaction.Dispose();<br>        transaction = null;<br>      }<br>    }<br>    public void Rollback()<br>    {<br>      if (transaction != null)<br>      {<br>        transaction.Rollback();<br>        transaction.Dispose();<br>        transaction = null;<br>      }<br>    }<br>    public void Dispose()<br>    {<br>      Close();<br>    }<br>  }<br>  public class Cursor : IDisposable<br>  {<br>    public Connect connect;<br>    protected IDbConnection connection;<br>    protected IDbCommand command;<br>    protected IDataReader reader;<br>    public IDbCommand Command { get { return command; } }<br>    public IDataReader Reader { get { return reader; } }<br>    public Cursor(Connect connect)<br>    {<br>      this.connect = connect;<br>      connection = connect.Connection;<br>    }<br>    private string ParameterShape(int no)<br>    {<br>      switch (connect.TypeOfParameter)<br>      {<br>        case ParameterType.QuestionMark:<br>          return "?";<br>        case ParameterType.Colon:<br>          return ":P"+no;<br>        case ParameterType.AtSymbol:<br>          return "@P"+no;<br>      }<br>      return "?";<br>    }<br>    public void Procedure(string proc)<br>    {<br>      command = connection.CreateCommand();<br>      command.CommandText = proc;<br>      command.CommandType = CommandType.StoredProcedure;<br>      command.Connection = connect.Connection;<br>      command.Transaction = connect.Transaction;<br>    }<br>    public void Format(string query, int count)<br>    {<br>      String[] parms = null;<br>      if (count &gt; 0)<br>        parms = new String[count];<br>      for (int i=0; i<count
 ;="" i="" parms[i="ParameterShape(i);"
 command="connection.CreateCommand();" if="" (count=""> 0)<br>        command.CommandText = string.Format(query, parms);<br>      else<br>        command.CommandText = query;<br>      command.Connection = connect.Connection;<br>      command.Transaction = connect.Transaction;<br>    }<br>    public void Run()<br>    {<br>      reader = command.ExecuteReader();<br>    }<br>    public void Exec()<br>    {<br>      command.ExecuteNonQuery();<br>    }<br>    public int GetInt(int ordinal)<br>    {<br>      if (reader.IsDBNull(ordinal))<br>        return 0;<br>      else<br>        return reader.GetInt32(ordinal);<br>    }<br>    public int GetInt(int ordinal, out bool isNull)<br>    {<br>      isNull = reader.IsDBNull(ordinal);<br>      if (isNull)<br>        return 0;<br>      else<br>        return reader.GetInt32(ordinal);<br>    }<br>    public string GetString(int ordinal)<br>    {<br>      if (reader.IsDBNull(ordinal))<br>        return "";<br>      else<br>        return reader.GetString(ordinal);<br>    }<br>    public string GetString(int ordinal, out bool isNull)<br>    {<br>      isNull = reader.IsDBNull(ordinal);<br>      if (isNull)<br>        return "";<br>      else<br>        return reader.GetString(ordinal);<br>    }<br>    public double GetDouble(int ordinal)<br>    {<br>      if (reader.IsDBNull(ordinal))<br>        return 0.0;<br>      else<br>        return reader.GetDouble(ordinal);<br>    }<br>    public double GetDouble(int ordinal, out bool isNull)<br>    {<br>      isNull = reader.IsDBNull(ordinal);<br>      if (isNull)<br>        return 0.0;<br>      else<br>        return reader.GetDouble(ordinal);<br>    }<br>    public DateTime GetDateTime(int ordinal)<br>    {<br>      if (reader.IsDBNull(ordinal))<br>        return System.DateTime.Now;<br>      else<br>        return reader.GetDateTime(ordinal);<br>    }<br>    public DateTime GetDateTime(int ordinal, out bool isNull)<br>    {<br>      isNull = reader.IsDBNull(ordinal);<br>      if (isNull)<br>        return System.DateTime.Now;<br>      else<br>        return reader.GetDateTime(ordinal);<br>    }<br>    public void Parameter(int no, object value, bool isNull)<br>    {<br>      IDbDataParameter parameter = command.CreateParameter();<br>      string p = ParameterShape(no);<br>      if (p != "?")<br>        parameter.ParameterName = p;<br>      if (isNull)<br>        parameter.Value = null;<br>      else<br>        parameter.Value = value;<br>      command.Parameters.Add(parameter);<br>    }<br>    public void Parameter(int no, object value)<br>    {<br>      Parameter(no, value, false);<br>    }<br>    public void Close()<br>    {<br>      if (reader != null)<br>      {<br>        reader.Close();<br>        reader.Dispose();<br>        reader = null;<br>      }<br>    }<br>    public bool Read()<br>    {<br>      return reader.Read();<br>    }<br>    public bool HasReader()<br>    {<br>      return reader != null;<br>    }<br>    public void Dispose()<br>    {<br>      Close();<br>    }<br>  }<br>}<br></count></pre>
<br>
<br>
</body>
</html>
